#!/usr/bin/perl

# Copyright (c) 2021 Gavin Hayes, see LICENSE in the root of the project

use strict;
use warnings;
use feature 'say';
use FindBin;
use lib "$FindBin::Bin";
use GIF::Encoder::PP;
use Devel::Peek;


#my @pallete =  (0x0000, 0x021F, 0x7FFF, 0x4210, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000);
#my @imdata = (
# 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0,
# 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 3,
# 1, 0, 2, 2, 2, 2, 2, 0, 2, 0, 0, 0, 2, 0, 1, 3,
# 1, 0, 0, 0, 2, 0, 0, 0, 2, 0, 0, 0, 2, 0, 1, 3,
# 1, 0, 0, 0, 2, 0, 0, 0, 2, 2, 2, 2, 2, 0, 1, 3,
# 1, 0, 0, 0, 2, 0, 0, 0, 2, 0, 0, 0, 2, 0, 1, 3,
# 1, 0, 0, 0, 2, 0, 0, 0, 2, 0, 0, 0, 2, 0, 1, 3,
# 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 3,
# 1, 0, 2, 2, 2, 0, 2, 2, 2, 0, 2, 0, 0, 0, 1, 3,
# 1, 0, 2, 0, 0, 0, 2, 0, 2, 0, 2, 0, 0, 0, 1, 3,
# 1, 0, 2, 2, 2, 0, 2, 2, 2, 0, 2, 0, 0, 0, 1, 3,
# 1, 0, 0, 0, 2, 0, 2, 0, 0, 0, 2, 0, 0, 0, 1, 3,
# 1, 0, 2, 2, 2, 0, 2, 0, 0, 0, 2, 2, 2, 0, 1, 3,
# 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 3,
# 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3,
# 0, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3,
#);

my @pallete = (0x0000, 0x0010, 0x0200, 0x0210, 0x4000, 0x4010, 0x4200, 0x4210, 0x6318, 0x001F, 0x03E0, 0x03FF, 0x7C00, 0x7C1F, 0x7FE0, 0x7FFF);
my @imdata = (
[
 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15
 ,15, 0, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15
 ,15, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 15, 15, 15, 0, 15
 ,15, 0, 15, 15, 0, 0, 15, 15, 0, 0, 0, 0, 0, 0, 0, 15
 ,15, 0, 0, 0, 15, 15, 0, 0, 15, 0, 15, 15, 0, 0, 0, 15
 ,15, 0, 0, 0, 15, 15, 0, 0, 15, 15, 0, 15, 0, 0, 0, 15
 ,15, 0, 15, 15, 0, 0, 15, 15, 0, 15, 0, 0, 15, 15, 0, 15
 ,15, 0, 15, 15, 0, 0, 15, 15, 0, 0, 15, 0, 15, 15, 0, 15
 ,15, 0, 0, 0, 15, 15, 0, 0, 15, 0, 15, 15, 0, 0, 0, 15
 ,15, 0, 0, 0, 15, 15, 0, 0, 0, 15, 0, 15, 0, 0, 0, 15
 ,15, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 15, 0, 15
 ,15, 0, 15, 15, 15, 15, 15, 15, 15, 15, 0, 0, 0, 0, 15, 15
 ,15, 0, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15
 ,15, 0, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15
 ,15, 0, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15
 ,15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15
],
[
 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15
 ,15, 0, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15
 ,15, 0, 0, 0, 0, 0, 15, 15, 15, 15, 0, 0, 0, 0, 15, 15
 ,15, 0, 15, 15, 0, 0, 0, 0, 0, 0, 15, 15, 0, 0, 0, 15
 ,15, 0, 0, 0, 15, 15, 0, 15, 0, 0, 15, 15, 0, 0, 0, 15
 ,15, 0, 0, 0, 15, 0, 15, 15, 0, 15, 0, 0, 15, 15, 0, 15
 ,15, 0, 15, 15, 0, 0, 15, 0, 15, 15, 0, 0, 15, 15, 0, 15
 ,15, 0, 15, 15, 0, 15, 0, 0, 15, 0, 15, 15, 0, 0, 0, 15
 ,15, 0, 0, 0, 15, 15, 0, 15, 0, 0, 15, 15, 0, 0, 0, 15
 ,15, 0, 0, 0, 15, 0, 15, 15, 0, 15, 0, 0, 15, 15, 0, 15
 ,15, 0, 0, 0, 0, 0, 15, 0, 15, 15, 0, 0, 0, 0, 0, 15
 ,15, 0, 15, 15, 15, 15, 0, 0, 0, 0, 15, 15, 15, 15, 0, 15
 ,15, 0, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15
 ,15, 0, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15
 ,15, 0, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15
 ,15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15
]);

my $PALETTE = '';
my $red_mask = 0x1F;
my $green_mask = 0x3E0;
my $blue_mask = 0x7C00;
my $ti = -1;
my $i = 0;
foreach my $rgb555 (@pallete) {
    my $red = ($rgb555 & $red_mask) << 3;
	my $green = (($rgb555 & $green_mask) >> 5) << 3;
	my $blue = (($rgb555 & $blue_mask) >> 10) << 3;
    $PALETTE .= pack('CCC', $red, $green, $blue);
    if(($rgb555 == 0) && ($ti == -1)) {
        $ti = $i; 
    }
    $i++;
}


my $gif = GIF::Encoder::PP->new('example.gif', 16, 16, $PALETTE, 4, 0, $ti);
$gif or die("fail to open gif");
say 'opened';
for my $frame (@imdata) {
    my $IMDATA = pack('C256', @$frame);
    $gif->{'frame'} = $IMDATA;
    $gif->add_frame(32);
}


$gif->finish();
say 'wrote gif';